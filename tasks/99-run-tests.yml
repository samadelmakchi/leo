---
- name: Run full test suite (only if test enabled + code updated)
  when:
    - customer_state == "up"
    - customer_test_enabled | bool
    - any_service_updated | default(false) | bool
  block:

    - name: Install Shekan 4040
      become: true
      block:
        - name: Backup sources.list
          copy:
            src: /etc/apt/sources.list
            dest: /etc/apt/sources.list.bak
            remote_src: yes

        - name: Use iranian mirror
          copy:
            content: |
              deb http://ir.archive.ubuntu.com/ubuntu noble main restricted universe multiverse
              deb http://ir.archive.ubuntu.com/ubuntu noble-updates main restricted universe multiverse
              deb http://ir.archive.ubuntu.com/ubuntu noble-backports main restricted universe multiverse
              deb http://security.ubuntu.com/ubuntu noble-security main restricted universe multiverse
            dest: /etc/apt/sources.list
            mode: '0644'

        - name: Active Shekan 404
          copy:
            content: |
              nameserver 178.22.122.100
              nameserver 185.51.200.2
            dest: /etc/resolv.conf
            backup: yes

    - name: Install required system packages
      become: true
      apt:
        name:
          - python3-pip
          - python3-venv
          - python3.12-venv
          - python3-full
          - libglib2.0-0
          - libnss3
          - libatk-bridge2.0-0
          - libatk1.0-0
          - libcups2
          - libdrm2
          - libxkbcommon0
          - libgbm1
          - libasound2t64
          - libxcomposite1
          - libxdamage1
          - libxrandr2
          - libpango-1.0-0
          - libcairo2
          - fonts-liberation
        state: present
        update_cache: yes
        cache_valid_time: 3600
      register: apt_install
      until: apt_install is succeeded
      retries: 5
      delay: 10

    - name: Remove old venv
      become: true
      file:
        path: /opt/test-venv
        state: absent

    - name: Create new venv
      become: true
      command: python3 -m venv /opt/test-venv
      args:
        creates: /opt/test-venv/bin/pip

    - name: Install all packages from PyPI
      become: true
      pip:
        name:
          - pip
          - wheel
          - setuptools
          - pytest
          - pytest-html
          - pytest-xdist
          - requests
          - selenium
          - playwright
          - locust
        state: latest
        executable: /opt/test-venv/bin/pip
        extra_args: --retries 20 --timeout 180

    - name: Install Playwright browsers on background
      become: true
      shell: |
        if [ ! -d "/opt/test-venv/.playwright" ] && [ ! -f "/opt/test-venv/.playwright-installing" ]; then
          touch /opt/test-venv/.playwright-installing
          nohup /opt/test-venv/bin/playwright install chromium --with-deps > /var/log/playwright-install.log 2>&1 &
          echo "Playwright در پس‌زمینه شروع شد (۲–۵ دقیقه)"
        else
          echo "Playwright قبلاً نصب شده یا در حال نصب است"
        fi
      ignore_errors: true

    - name: Create report folder
      file:
        path: "{{ log_path }}/test-reports/{{ inventory_hostname }}"
        state: directory
        mode: "0755"

    - name: Run tests
      become: true
      command: >-
        /opt/test-venv/bin/pytest "{{ tests_path }}"
        -n auto
        --html=report.html
        --self-contained-html
        {% if customer_test_fail_fast | default(false) %}--maxfail=1{% endif %}
      args:
        chdir: "{{ log_path }}/test-reports/{{ inventory_hostname }}"
      register: test_result
      changed_when: false
      failed_when: test_result.rc not in [0,1,2,3,4,5]
      ignore_errors: true

    # نمایش نتیجه (همیشه نشون می‌ده)
    - name: Show result
      debug:
        msg: |
          تست‌ها اجرا شدن!
          {% if test_result.rc == 0 %}همه پاس شدن
          {% elif test_result.rc == 1 %}بعضی تست‌ها fail شدن
          {% elif test_result.rc in [2,3,4] %}تست‌ها skip یا خطای داخلی (معمولاً مرورگر نیست — چند دقیقه دیگه دوباره بزن)
          {% else %}خطای ناشناخته (rc={{ test_result.rc }})
          {% endif %}
          گزارش → {{ log_path }}/test-reports/{{ inventory_hostname }}/report.html
          لاگ نصب Playwright → /var/log/playwright-install.log

  tags: test