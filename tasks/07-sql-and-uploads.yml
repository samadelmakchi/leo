# tasks/07-sql-and-uploads.yml ← نسخهٔ نهایی، بدون خطا
---
- name: Restore SQL + Uploads + .env (فقط فایل‌های موجود)
  when: customer_state == "up"
  block:

    # ۱. Gateway → اولویت: simnad_gateway.sql → در غیر اینصورت default_gateway.sql
    - name: "[Gateway] انتخاب فایل SQL مناسب"
      set_fact:
        gateway_sql_path: >-
          {{ lookup('fileglob', playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_gateway.sql')
             or (playbook_dir ~ '/sql/default_gateway.sql') }}

    - name: "[Gateway] کپی SQL به init (همیشه انجام میشه)"
      ansible.builtin.copy:
        src: "{{ gateway_sql_path }}"
        dest: "{{ project_path }}/{{ inventory_hostname }}/gateway/docker/init/install.sql"
        mode: "0644"

    # بقیه سرویس‌ها (همه با شرط ساده و ایمن)
    - name: "[Gateway] کپی uploads"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_gateway_uploads.zip"
        dest: /tmp/{{ inventory_hostname }}_gateway_uploads.zip
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_gateway_uploads.zip') is file
      ignore_errors: true

    - name: "[Gateway] استخراج uploads"
      ansible.builtin.unarchive:
        src: /tmp/{{ inventory_hostname }}_gateway_uploads.zip
        dest: "{{ project_path }}/{{ inventory_hostname }}/gateway/admin/uploads"
        creates: "{{ project_path }}/{{ inventory_hostname }}/gateway/admin/uploads/index.html"
        remote_src: yes
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_gateway_uploads.zip') is file
      ignore_errors: true


    # ۲. Portal
    - name: "[Portal] Restore SQL"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_portal.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/portal/docker/init/install.sql"
        mode: "4"
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_portal.sql') is file
      ignore_errors: true


    # ۳. Frontend
    - name: "[Frontend] کپی و استخراج"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_frontend.zip"
        dest: /tmp/{{ inventory_hostname }}_frontend.zip
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_frontend.zip') is file
      ignore_errors: true

    - name: "[Frontend] استخراج"
      ansible.builtin.unarchive:
        src: /tmp/{{ inventory_hostname }}_frontend.zip
        dest: "{{ project_path }}/{{ inventory_hostname }}/portal-frontend"
        exclude: [node_modules, .git]
        remote_src: yes
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_frontend.zip') is file
      ignore_errors: true


    # ۴. LMS
    - name: "[LMS] Restore SQL"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_lms.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/docker/init/install.sql"
        mode: "4"
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_lms.sql') is file
      ignore_errors: true

    - name: "[LMS] Restore uploads"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_lms_uploads.zip"
        dest: /tmp/{{ inventory_hostname }}_lms_uploads.zip
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_lms_uploads.zip') is file
      ignore_errors: true

    - name: "[LMS] استخراج"
      ansible.builtin.unarchive:
        src: /tmp/{{ inventory_hostname }}_lms_uploads.zip
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/storage/app"
        remote_src: yes
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_lms_uploads.zip') is file
      ignore_errors: true

    - name: "[LMS] Restore .env"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_lms.env"
        dest: "{{ project_path }}/{{ inventory_hostname }}/lms/.env"
        mode: "0600"
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_lms.env') is file
      ignore_errors: true


    # ۵. File (همان الگو)
    - name: "[File] Restore SQL"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_file.sql"
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/docker/init/install.sql"
        mode: "4"
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_file.sql') is file
      ignore_errors: true

    - name: "[File] Restore uploads"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_file_uploads.zip"
        dest: /tmp/{{ inventory_hostname }}_file_uploads.zip
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_file_uploads.zip') is file
      ignore_errors: true

    - name: "[File] استخراج"
      ansible.builtin.unarchive:
        src: /tmp/{{ inventory_hostname }}_file_uploads.zip
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/storage/app"
        remote_src: yes
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_file_uploads.zip') is file
      ignore_errors: true

    - name: "[File] Restore .env"
      ansible.builtin.copy:
        src: "{{ playbook_dir }}/sql/{{ inventory_hostname }}_file.env"
        dest: "{{ project_path }}/{{ inventory_hostname }}/file/.env"
        mode: "0600"
      when: (playbook_dir ~ '/sql/' ~ inventory_hostname ~ '_file.env') is file
      ignore_errors: true